// Duckdown (0.0.1)
// Simple, lightweight Markdown-like language with extensible grammar.
// Christopher Giffard 2012
// 
// 
// Package built Thu Aug 02 2012 14:37:42 GMT+1000 (EST)
// 


(function(e){function t(e){return window[{"./ducknode.js":"DuckdownNode","./index.js":"Duckdown","./grammar.js":"DuckdownGrammar"}[e]]}(function(e){"use strict";var t={};t.wordCharacters=/[a-z0-9 ]/ig,t.escapeCharacters=/[^a-z0-9\s\-\_\:\\\/\=\%\~\`\!\@\#\$\*\(\)\+\[\]\{\}\|\;\,\.\?\']/ig,t.replacer=function(e,t,n){return e==="&"?"&amp;":e==="<"?"&lt;":e===">"?"&gt;":e==='"'?"&quot;":"&#x"+e.charCodeAt(0).toString(16)+";"},t.tokenMappings={"\n":{wrapper:!0,swallowTokens:!1,exit:/\n/,state:"IMPLICIT_BREAK",semanticLevel:"hybrid"},"&":{wrapper:!1,exit:/([^#a-z0-9]|;)/i,validIf:/^&#?[a-z0-9]+;$/ig,state:"ENTITY",semanticLevel:"text"},"~":{semanticLevel:"text",wrapper:!0,allowSelfNesting:!1,exit:/[\~\n]/,validIf:/^\~\S[^\n]+\S\~$/,state:"TEXT_EMPHASIS"},"*":{semanticLevel:"text",wrapper:!0,allowSelfNesting:!1,exit:/[\*\n]/,validIf:/^\*\S[^\n]+\S\*$/,state:"TEXT_STRONG"},"<":{wrapper:!1,semanticLevel:"hybrid",exit:/[>\n]/,validIf:/^<[a-z][a-z0-9\-\_]*(\s[^>\n]+)*>$/i,state:"SPECIAL_FEATHER"},"`":{wrapper:!1,semanticLevel:"text",exit:/[`\n]/,state:"CODE_LITERAL"},"h1.":{wrapper:!0,exit:/\n/i,state:"HEADING_1",semanticLevel:"textblock"},"h2.":{wrapper:!0,exit:/\n/i,state:"HEADING_2",semanticLevel:"textblock"},"h3.":{wrapper:!0,exit:/\n/i,state:"HEADING_3",semanticLevel:"textblock"},"h4.":{wrapper:!0,exit:/\n/i,state:"HEADING_4",semanticLevel:"textblock"},"h5.":{wrapper:!0,exit:/\n/i,state:"HEADING_5",semanticLevel:"textblock"},"h6.":{wrapper:!0,exit:/\n/i,state:"HEADING_6",semanticLevel:"textblock"},"http://":{wrapper:!1,exit:/[^a-z0-9\-_\.\~\!\*\'\(\)\;\:\@\&\=\+\$\,\/\?\%\#\[\]\#]/i,state:"AUTO_LINK",swallowTokens:!1,semanticLevel:"text"},"https://":{wrapper:!1,exit:/[^a-z0-9\-_\.\~\!\*\'\(\)\;\:\@\&\=\+\$\,\/\?\%\#\[\]\#]/i,state:"AUTO_LINK",swallowTokens:!1,semanticLevel:"text"},"(":{wrapper:!0,exit:/(\s\s+|\n|\))/,state:"PAREN_DESCRIPTOR",allowSelfNesting:!0,semanticLevel:"text"}},t.stateList={ENTITY:{process:function(){},compile:function(e,t){var n=e.children[e.children.length-1];return e.exitToken===";"?"&"+e.children.join("")+";":typeof n=="string"&&n.match(/\;/)?"&"+e.children.join(""):"&amp;"+t(e.children)}},IMPLICIT_BREAK:{process:function(e){if(!e.text().length)return!1},compile:function(e,t){var n=t(e.children),r=!1;for(var i=0;i<e.children.length;i++)if(e.children[i]instanceof Object&&e.children[i].semanticLevel!=="hybrid"&&e.children[i].semanticLevel!=="text"){r=!0;break}return r?n+"\n":"<p>"+n+"</p>\n"}},TEXT_EMPHASIS:{compile:function(e,t){return"<em>"+t(e)+"</em>"}},TEXT_STRONG:{compile:function(e,t){return"<strong>"+t(e)+"</strong>"}},CODE_LITERAL:{compile:function(e,t){return"<code>"+e.text()+"</code>"}},HEADING_1:{process:function(e){if(e.previousSibling)return!1},compile:function(e,t){return"<h1>"+t(e)+"</h1>"}},HEADING_2:{process:function(e){if(e.previousSibling)return!1},compile:function(e,t){return"<h2>"+t(e)+"</h2>"}},HEADING_3:{process:function(e){if(e.previousSibling)return!1},compile:function(e,t){return"<h3>"+t(e)+"</h3>"}},HEADING_4:{process:function(e){if(e.previousSibling)return!1},compile:function(e,t){return"<h4>"+t(e)+"</h4>"}},HEADING_5:{process:function(e){if(e.previousSibling)return!1},compile:function(e,t){return"<h5>"+t(e)+"</h5>"}},HEADING_6:{process:function(e){if(e.previousSibling)return!1},compile:function(e,t){return"<h6>"+t(e)+"</h6>"}},AUTO_LINK:{compile:function(e,t){var n=e.token+e.text(),r=n;return e.parent&&e.parent.state==="PAREN_DESCRIPTOR"&&!!e.parent.link?n:(e.linkDetail&&(r=t(e.linkDetail)),'<a href="'+n+'">'+r+"</a>")}},PAREN_DESCRIPTOR:{process:function(e){e.previousSibling&&e.previousSibling.state==="AUTO_LINK"&&(e.previousSibling.linkDetail||(e.previousSibling.linkDetail=e,e.link=e.previousSibling))},compile:function(e,t){return e.link?"":"("+t(e)+")"}},SPECIAL_FEATHER:{process:function(e){if(!e.children.length)return;var t=e.children.join("").split(/\s+/ig);e.children=[];var n=t.shift().replace(/\s+/ig,""),r={};if(!n.length)return;if(this.feathers[n]&&this.feathers[n]instanceof Function){var i=0,s=[],o=[];for(var u=0;u<t.length;u++){var a=t[u];i===0?a.match(/\:/)?(a=a.split(/[:]+/),s.push(a.shift()),o=o.concat(a),i=1):s.push(a):a.match(/\:/)?(i=0,u--,r[s.join(" ")]=o.join(" "),s=[],o=[]):o.push(a)}if(s.length||o.length)r[s.join(" ")]=o.join(" ");var f=this.feathers[n](r);e.compiled=!0;if(typeof f=="string"||typeof f=="number")e.children=[f]}return}}},typeof module!="undefined"&&module.exports?module.exports=t:typeof define!="undefined"?define("DuckdownGrammar",[],function(){return t}):e.DuckdownGrammar=t})(this),function(e){var n=t("./grammar.js"),r=function(e){this.state=e&&typeof e=="string"?e:"NODE_TEXT",this.stateStack=[],this.depth=0,this.children=[],this.parent=null,this.wrapper=!0,this.token="",this.exitToken="",this.textCache="",this.rawCache="",this.previousSibling=null,this.semanticLevel="text"};r.prototype.text=function(){var e="";if(!this.textCache.length){for(var t=0;t<this.children.length;t++)if(this.children[t]instanceof r)e+=this.children[t].text();else{if(typeof this.children[t]!="string"&&typeof this.children[t]!="number")throw new Error("Unable to coerce unsupported type to string!");var i=this.children[t].replace(n.escapeCharacters,n.replacer);e+=i}return this.textCache=e,this.textCache}return this.textCache},r.prototype.raw=function(){var e="";if(!this.rawCache.length){e+=this.token;for(var t=0;t<this.children.length;t++)if(this.children[t]instanceof r)e+=this.children[t].raw();else{if(typeof this.children[t]!="string"&&typeof this.children[t]!="number")throw new Error("Unable to coerce unsupported type to string!");e+=this.children[t]}return e+=this.exitToken,this.rawCache=e,this.rawCache}return this.rawCache},r.prototype.toString=function(){return"<"+this.state+":"+this.children.length+">"},typeof module!="undefined"&&module.exports?module.exports=r:typeof define!="undefined"?define("DuckdownNode",[],function(){return r}):e.DuckdownNode=r}(this),function(e){"use strict";var n=t("./grammar.js"),r=t("./ducknode.js"),i=0,s=1,o=0,u=function(t){this.options=t instanceof Object?t:{},this.clear()};u.prototype.clear=function(){this.currentToken="",this.prevToken="",this.tokenPosition=0,this.parserStates=[],this.parserAST=[],this.parseBuffer=[],this.currentNode=null,this.prevNode=null,this.nodeDepth=0,this.characterIndex=0,this.tokeniserState=i,this.tokenBuffer="",this.tokens=[],this.curChar="",this.prevChar="",this.feathers={},this.tokenList=function(){var e=[];for(var t in n.tokenMappings)n.tokenMappings.hasOwnProperty(t)&&e.push(t);return e}(),this.longestToken=this.tokenList.sort(function(e,t){return t.length-e.length}).slice(0,1).pop().length},u.prototype.tokenise=function(e){typeof e!="string"&&(e=String(e)),this.tokens.length||(e="\n"+e);var t=!e||!e.length?0:e.length;this.prevChar="",this.curChar="";for(var r=0;r<=t;r++){this.curChar=e.charAt(r);var o=this.longestToken;o=o>t-r?t-r:o;for(;o>0;o--){var u=e.substr(r,o);if(n.tokenMappings[u]){this.tokenBuffer.length&&(this.tokens.push(this.tokenBuffer),this.tokenBuffer=""),this.tokens.push(u),r+=o-1;break}o===1&&(!this.curChar.match(n.wordCharacters)&&this.tokeniserState===s||this.curChar.match(n.wordCharacters)&&this.tokeniserState===i?this.tokenBuffer+=this.curChar:(this.tokenBuffer.length&&(this.tokens.push(this.tokenBuffer),this.tokenBuffer=""),this.tokenBuffer+=this.curChar,this.tokeniserState=[s,i][this.tokeniserState]))}this.characterIndex=r,this.prevChar=this.curChar}return this.tokenBuffer.length&&(this.tokens.push(this.tokenBuffer),this.tokenBuffer=""),this.tokens},u.prototype.parse=function(e){e&&typeof e=="string"&&this.tokenise(e);for(;this.tokenPosition<this.tokens.length;this.tokenPosition++)this.parseToken(this,null);return this.parserAST},u.prototype.parseToken=function(e,t){function l(){if(!e.parserStates.length)return!0;var t=e.parserStates[e.parserStates.length-1],n=c(t);return n?n.wrapper:!1}function c(e){if(!n.stateList[e])return!1;if(!n.stateList[e].tokenGenus){for(var t in n.tokenMappings)if(n.tokenMappings.hasOwnProperty(t)&&n.tokenMappings[t].state===i)return n.stateList[e].tokenGenus=n.tokenMappings[t],n.tokenMappings[t];return!1}return n.stateList[e].tokenGenus}function h(t){if(!e.currentNode)return!0;if(!t.semanticLevel)return!0;if(t.semanticLevel==="hybrid")return!0;var n="hybrid",r={hybrid:4,block:3,textblock:2,text:1};for(var i=0;i<e.parserStates.length;i++){var s=c(e.parserStates[i]);s.semanticLevel&&r[s.semanticLevel]<r[n]&&(n=s.semanticLevel)}return r[t.semanticLevel]>r[n]?!1:t.semanticLevel==="textblock"&&n==="textblock"?!1:!0}var i,s,o,a,f;this instanceof u&&(e=this),t&&t.length&&(e.tokens.push(t),e.tokenPosition=e.tokens.length-1),e.currentToken=e.tokens[e.tokenPosition];var p="";for(var d=e.parserStates.length-1;d>=0;d--){i=e.parserStates[d],a=n.stateList[i];var v=c(i);v&&(a.exitCondition=v.exit);if(!a)throw new Error("State genus for the state "+i+" was not found!");if(a.exitCondition&&a.exitCondition.exec(e.currentToken)){var m=null,g=!1,y=a.exitCondition.exec(e.currentToken),b=y.index,w=y[0]?y[0].length:0;b>0&&e.parseBuffer.push(e.currentToken.substr(0,b)),e.currentNode.children.push.apply(e.currentNode.children,e.parseBuffer),e.currentNode.exitToken=y[0],v&&v.validIf instanceof RegExp&&(v.validIf.exec(e.currentNode.raw())||(g=!0)),g?e.parseBuffer=[e.currentNode.token].concat(e.parseBuffer):e.parseBuffer=[],!g&&a.process&&a.process instanceof Function&&(m=a.process.call(e,e.currentNode)),!g&&m!==!1&&(e.prevNode=e.currentNode),e.currentNode=e.currentNode.parent,e.nodeDepth--,e.parserStates.length=e.nodeDepth;if(m===!1||g)f=e.currentNode?e.currentNode.children:e.parserAST,f.length--;if(a.tokenGenus.swallowTokens!==!1&&!g){e.currentToken=e.currentToken.substring(b+w);if(!e.currentToken.length)return}}}if(n.tokenMappings[this.currentToken]){o=n.tokenMappings[e.currentToken],s=o.state,a=n.stateList[o.state];if(e.hasParseState(o.state)&&!o.allowSelfNesting)e.parseBuffer.push(e.currentToken);else if(l()&&h(o)){e.addParseState(o.state);var E=new r(o.state);E.stateStack=e.parserStates.slice(0),E.depth=e.nodeDepth,E.parent=e.currentNode,E.wrapper=o.wrapper,E.token=this.currentToken,o.semanticLevel&&(E.semanticLevel=o.semanticLevel),e.parseBuffer.length?E.previousSibling=e.parseBuffer[e.parseBuffer.length-1]:(f=e.currentNode?e.currentNode.children:e.parserAST,f.length&&(E.previousSibling=f[f.length-1])),e.currentNode?(e.currentNode.children.push.apply(e.currentNode.children,e.parseBuffer),e.currentNode.children.push(E)):(e.parserAST.push.apply(e.parserAST,e.parseBuffer),e.parserAST.push(E)),e.parseBuffer=[],e.currentNode=E,e.nodeDepth++}else e.parseBuffer.push(e.currentToken)}else e.currentToken.length&&e.parseBuffer.push(e.currentToken),e.tokenPosition>=e.tokens.length-1&&(e.currentNode?e.currentNode.children.push.apply(e.currentNode.children,e.parseBuffer):e.parserAST.push.apply(e.parserAST,e.parseBuffer),e.parseBuffer=[]);e.previousToken=e.currentToken},u.prototype.compile=function(e){return e&&this.parse(e),function t(e){var i="";e instanceof r&&(e=e.children);if(e instanceof Array){for(var s=0;s<e.length;s++){var o=e[s];if(o instanceof r){if(o.children.length&&o.text().length){var u=n.stateList[o.state];u&&u.compile&&u.compile instanceof Function?i+=u.compile(o,t):i+=o.text()}}else if(typeof o=="number"||typeof o=="string"){var a=o;n.replacer&&n.replacer instanceof Function&&(a=a.replace(n.escapeCharacters,n.replacer)),i+=a}}return i.replace(/\s+/g,"").length?i:""}return i}(this.parserAST)},u.prototype.toString=function(){return this.compile()},u.prototype.registerFeather=function(e,t){if(!e.match(/^[a-z0-9]+$/))throw new Error("Feather names must consist of lowercase letters and numbers only.");if(this.feathers[e])throw new Error("A feather with the specified name already exists.");if(!(t&&t instanceof Function))throw new Error("You must provide a function for processing the feather output.");this.feathers[e]=t},u.prototype.unregisterFeather=function(e){if(!this.feathers[e])throw new Error("Requested feather does not exist.");delete this.feathers[e]},u.prototype.hasParseState=function(e){for(var t=0;t<this.parserStates.length;t++)if(this.parserStates[t]===e)return!0;return!1},u.prototype.addParseState=function(e){this.parserStates.push(e)},typeof module!="undefined"&&module.exports?module.exports=u:typeof define!="undefined"?define("Duckdown",[],function(){return u}):e.Duckdown=u}(this)})(this)